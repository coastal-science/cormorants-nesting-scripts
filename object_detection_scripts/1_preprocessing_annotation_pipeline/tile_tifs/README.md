# Tile TIFs
This section contains the code used for splitting `.tif` files containing full
orthomosaic panoramas into smaller jpg tiles.

**Table of Contents**
* [Running `tile_tifs.py`](#running-tiletifspy)
  * [CLI Arguments](#cli-arguments)
  * [Expected Output](#expected-output)
* [Examples](#examples)

## Running `tile_tifs.py`
### CLI Arguments
`tile_tifs.py` provides a CLI for tiling TIF files using Python. When running
this file from the command line, you must provide the following: 
* `--tif_file` or `--tif_dir`: The file path to a single TIF file or a directory
   containing multiple TIF files. 
* `--out_dir`: The path to the directory where output will be written. For each
  tiled TIF, a folder is created in this directory which will contain all
  resulting JPGs.
* `--tile_height`: The height, in pixels, to use for tiling.
* `--tile_width`: The width, in pixels, to use for tiling.

The following optional argument(s) can also be provided: 
* `--mask_file`: The path to a CSV containing a mask for each of the TIFs being
  tiled. Each mask row must have a value for two columns: 
  * `img.img_path`: a path whose file name exactly matches the TIF's filename
    (e.g. `20200517.tif`).
  * `anno.data`: a list of x, y coordinates that form the masking polygon. Any
    pixels within this polygon will be retained, while any pixels outside this
    polygon will be masked (i.e. turned to black). Coordinates are not pixel
    values, but instead are normalized values between 0 & 1, so that the top
    left corner is represented as (0,1) and the bottom right corner is
    represented as (1,1). For example, a mask covering the left half of an 
    image would be represented by the following mask: 
    `[{"x": 0, "y": 0}, {"x":0.5, "y":0}, {"x":0.5, "y":1}, {"x":0, "y":1}, {"x": 0, "y": 0}]`.
    Please note, by default the LOST annotation tool outputs annotations in this
    format.

### Expected Output
Assuming all arguments have been specified correctly, a new folder will be
created inside the specified `--out_dir` directory for each tiled TIF. Each
folder will share the name of the TIF whose tiles are contained within it. 

#### Tile Naming
Tiles are named based on their order in the original image, following the 
format `{vertical_tile}.{horizontal_tile}.jpg`. Using this scheme, the top left
tile (the origin tile) is named `0.0.jpg`, the tile directly below the origin
tile is `1.0.jpg`, and the tile directly to the right of the origin tile is 
`0.1.jpg`.

#### Impact of Masking
When masking is used, all pixels outside the provided masking polygon become
black (`#000000`). Any tiles which are entirely outside the masking polygon 
(i.e. are entirely black) are not saved to JPGs. Any tiles which partially
overlap with the masking polygon will have artificially black pixels, 
representing the portion of the tile which was not within the mask.

## Examples
### Tile a single TIF
```python
python3 tile_tifs.py \
   --tif_file ../input/2022/file.tif \
   --out_dir ../output/2022/ \
   --tile_height 1000 \
   --tile_width 1000
```

### Tile a tif_directory of TIFs
```python
python3 tile_tifs.py \
    --tif_dir ../input/2022/  \
    --out_dir ../output/2022/ \
    --tile_height 1000 \
    --tile_width 1000
```

### Tile a single TIF, taking a mask into account
```python
python3 tile_tifs.py \
    --tif_file ../input/2022/file.tif
    --out_dir ../output/2022/
    --mask_file ../input/2022/mask.csv
    --tile_height 1000
    --tile_width 1000
```

### Tile a directory of TIFs, taking masks into account
```python
python3 tile_tifs.py \
    --tif_dir ../input/2022/ \
    --out_dir ../output/2022/ \
    --mask_file ../input/2022/masks.csv \
    --tile_height 1000 \
    --tile_width 1000
```

## Troubleshooting

### Cannot Open TIF
The most commonly perplexing problem can arise when attempting to tile an
improperly encoded/formatted TIF file. For some unknown reason, the panoramas
generated by the stitching software are occasionally unable to be read by
Python or default image viewers on Mac and Windows computers.

In these cases, when attempting to open the file from Finder (Mac) or the File 
Explorer (Windows) an error appears quickly to say that the file "could not be
opened". If opening from Finder on Mac, you receive a message saying "it may
be damaged or use a file format that Preview doesnâ€™t recognize". 

Upon examining the file you often see that the file size is much larger than 
other stitched images. For this reason, its often assumed that the image is
simply too large for your computer to handle. 

However, the real issue lies in the encoding of the TIF file. To fix this, you
need to do one of the following: 
1. Re-stitch the image.
2. Open the image in a photo-editing tool such as GIMP or Photoshop. If using
   GIMP, you can follow these steps: 
   * Open the image in GIMP.
   * It will likely take a long time for the image to open, but eventually you
     should be met with a dialog titled "Convert to RGB Working Space?". Select
     "Convert", using all the defaults.
   * Export the image by selecting File>Export
     * Specify the location and name to use when saving the new image. 
     * Hit "Export"
   * A "Export Image as TIFF" dialog will appear. 
     * Select LZW compression
     * Hit "Export"
   * You should see a progress bar appear and advance as the image is exported.
   * Once exporting is completed, find the file in Finder or File Explorer and
     confirm you can now open it successfully.